name: CD

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

permissions:
  contents: write

env:
  IMAGE_REPO: astraluniverse/bank-app-cd

jobs:
  build_push_release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Set tag
        run: echo "TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_REPO }}:latest
            ${{ env.IMAGE_REPO }}:${{ env.TAG }}

      - name: Update Helm values.yaml image tag
        run: |
          python - <<'PY'
          import re, pathlib, os
          p = pathlib.Path("helm/bank-app-cd/values.yaml")
          s = p.read_text()
          s = re.sub(r'(?m)^(\s*tag:\s*)".*"$', r'\1"'+os.environ["TAG"]+'"', s)
          p.write_text(s)
          PY
        env:
          TAG: ${{ env.TAG }}

      - name: Bump Chart.yaml patch version
        run: |
          python - <<'PY'
          import re, pathlib
          p = pathlib.Path("helm/bank-app-cd/Chart.yaml")
          s = p.read_text()
          m = re.search(r'(?m)^version:\s*(\d+)\.(\d+)\.(\d+)\s*$', s)
          if not m:
            raise SystemExit("Chart.yaml version not found")
          a,b,c = map(int, m.groups())
          c += 1
          s = re.sub(r'(?m)^version:\s*.*$', f"version: {a}.{b}.{c}", s)
          p.write_text(s)
          PY

      - name: Commit and push chart bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add helm/bank-app-cd/Chart.yaml helm/bank-app-cd/values.yaml
          git commit -m "chore(cd): release ${TAG}" || exit 0
          git push
        env:
          TAG: ${{ env.TAG }}
